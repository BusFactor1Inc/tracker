;; -*- mode: lisp -*-
(defview *Note-pitch-view
    tag-name :span
    model 'note
    events (create
            'click (lambda (e)
                     (this.trigger :edit this)))

    init (lambda (model)
           (this.note.on :change this.render this))
    render (lambda ()
             (this.$el.text (or (hex (this.note.pitch)) "--"))
             ))

(defview *Note-fx-view
    tag-name :span
    model 'note
    events (create
            'click (lambda (e)
                     (this.trigger :edit this)))
    init (lambda (model)
           (this.note.on :change this.render this))
    render (lambda ()
             (this.$el.text (or (hex (this.note.fx)) "--"))
             ))

(defview *Note-arg-view
    tag-name :span
    model 'note
    events (create
            'click (lambda (e)
                     (this.trigger :edit this)))
    init (lambda (model)
           (this.note.on :change this.render this))
    render (lambda ()
             (this.$el.text (or (hex (this.note.arg)) "--"))
             ))

(defview *Note-instrument-view
    tag-name :span
    model 'note
    events (create
            'click (lambda (e)
                     (this.trigger :edit this)))
    init (lambda (model)
           (this.note.on :change this.render this))
    render (lambda ()
             (this.$el.text (or (hex (this.note.instrument)) "--"))
             ))

(defview *Note-view
    model 'note
    init (lambda (model)
           (this.create 'pitch-view (new (*View *Note-pitch-view this.note)))
           (this.create 'fx-view (new (*View *Note-fx-view this.note)))
           (this.create 'arg-view (new (*View *Note-arg-view this.note)))
           (this.create 'instrument-view (new (*View *Note-instrument-view this.note)))

           (this.on :edit
                    (lambda (e)
                      (let (el)
                        (cond 
                          ((= ((@ this pitch-view)) e.value)
                           ((@ this pitch-view)
                            (setf el (new (*View *Two-character-hex-value-edit-view
                                                 this.note this.note.pitch)))))
                          ((= ((@ this fx-view)) e.value)
                           ((@ this fx-view)
                            (setf el (new (*View *Two-character-hex-value-edit-view
                                                 this.note this.note.fx)))))
                          ((= ((@ this arg-view)) e.value)
                           ((@ this arg-view)
                            (setf el (new (*View *Two-character-hex-value-edit-view
                                                 this.note this.note.arg)))))
                          ((= ((@ this instrument-view)) e.value)
                           ((@ this instrument-view)
                            (setf el (new (*View *Two-character-hex-value-edit-view
                                                 this.note this.note.instrument))))))
                        (this.render)
                        ((@ (@ el $el) focus))
                        ((@ (@ el $el) select)))))
                            
           (this.on :end-edit
                    (lambda (e)
                      (cond
                        ((= ((@ this pitch-view)) e.value)
                         ((@ this pitch-view) 
                          (new (*View *Note-pitch-view this.note))))
                        ((= ((@ this fx-view)) e.value)
                         ((@ this fx-view) 
                          (new (*View *Note-fx-view this.note))))
                        ((= ((@ this arg-view)) e.value)
                         ((@ this arg-view) 
                          (new (*View *Note-arg-view this.note))))
                        ((= ((@ this instrument-view)) e.value)
                         ((@ this instrument-view) 
                          (new (*View *Note-instrument-view this.note)))))
                      (this.render)))
           )
    render (lambda ()            
             (this.$el.html (array
                             ((@ ((@ this pitch-view)) render))
                             "&nbsp;"
                             ((@ ((@ this fx-view)) render))
                             "&nbsp;"
                             ((@ ((@ this arg-view)) render))
                             "&nbsp;"
                             ((@ ((@ this instrument-view)) render))))))
