;; -*- mode: lisp -*-

(defview *Channel-move-left-button-view
    model 'channel
    class-name "TinyButton"
    events (create
            'click (lambda (e)
                     (this.channel.trigger :move-channel-left this.channel)))
    render (lambda ()
             (this.$el.html "←")))

(defview *Channel-move-right-button-view
    model 'channel
    class-name "TinyButton"
    events (create
            'click (lambda (e)
                     (this.channel.trigger :move-channel-right this.channel)))
    render (lambda ()
             (this.$el.html "→")))

(defview *Channel-add-button-view
    model 'channel
    class-name "TinyButton"
    events (create
            'click (lambda (e)
                     (this.channel.trigger :add-channel this.channel)))
    render (lambda ()
             (this.$el.html "+")))

(defview *Channel-copy-button-view
    model 'channel
    class-name "TinyButton"
    events (create
            'click (lambda (e)
                     (this.channel.trigger :copy-channel this.channel)))
    render (lambda ()
             (this.$el.html "⎘")))

(defview *Channel-close-button-view
    model 'channel
    class-name "TinyButton ChannelCloseButton"
    events (create
            'click (lambda (e)
                     (when (confirm "Are you sure you want to delete this channel?")
                       (this.channel.trigger :close-channel this.channel))))
    render (lambda ()
             (this.$el.html "✗")))

(defview *Channel-monitor-view
    model 'channel
    events (create
            'click (lambda (e)
                     (alert :click))))

(defview *Channel-title-view
    model 'channel
    init (lambda (model)
           (this.create 'left-button (new (*View *Channel-move-left-button-view model)))
           (this.create 'right-button (new (*View *Channel-move-right-button-view model)))
           (this.create 'close-button (new (*View *Channel-close-button-view model)))
           (this.create 'add-button (new (*View *Channel-add-button-view model)))
           (this.create 'copy-button (new (*View *Channel-copy-button-view model))))
    render (lambda ()
             (let ((html (array
                          ((@ ((@ this left-button)) render))
                          ((@ ((@ this right-button)) render))
                          ((@ ((@ this add-button)) render))
                          ((@ ((@ this copy-button)) render))
                          ((@ ((@ this close-button)) render))
                     )))
               (this.$el.html html))))

(defview *Channel-solo-button-view
    model 'channel
    events (create
            :click (lambda (e)
                     (this.channel.solo (not (this.channel.solo)))
                     (this.render)))
    render (lambda ()
             (if (this.channel.solo)
                 (this.$el.attr 'class "Button ButtonEnabled")
                 (this.$el.attr 'class "Button ButtonDisabled"))
             (this.$el.text "S")))

(defview *Channel-mute-button-view
    model 'channel
    events (create
            :click (lambda (e)
                     (this.channel.mute (not (this.channel.mute)))
                     (this.render)))
    render (lambda ()
             (if (this.channel.mute)
                 (this.$el.attr 'class "Button ButtonEnabled")
                 (this.$el.attr 'class "Button ButtonDisabled"))
             (this.$el.text "M")))

(defview *Channel-controls-view
    model 'channel
    init (lambda (model)
           (this.create 'solo-button (new (*View *Channel-solo-button-view this.channel)))
           (this.create 'mute-button (new (*View *Channel-mute-button-view this.channel)))
           (this.create 'gain-view (new (*View *Hex-value-edit-view this.channel
                                               "ChannelGainView" this.channel.gain 2)))
           (this.create 'pan-view (new (*View *Hex-value-edit-view this.channel
                                               "ChannelPanView" this.channel.pan 2))))
    render (lambda ()
             (let ((html (array
                          ((@ ((@ this gain-view)) render))
                          ((@ ((@ this solo-button)) render))
                          ((@ ((@ this mute-button)) render))
                          ((@ ((@ this pan-view)) render))
                     )))
               (this.$el.html html))))

(defview *Channel-name-edit-view
    tag-name "input type='text' size='8'"
    model 'channel
    init (lambda (model model-value-fn)
           (setf (@ this model-value-fn) model-value-fn)
           (this.$el.val ((@ model-value-fn call) this.note)))
    events (create
            :keypress (lambda (e)
                        (if (= (@ e key-code) 13)
                            (this.finished)))
            :blur (lambda (e)
                      (this.finished)))
    finished (lambda ()
               ((@ this model-value-fn call) this.note
                (or (this.$el.val) (this.channel.index)))
               (this.trigger :end-edit-name this)))

(defview *Channel-name-view
    model 'channel
    events (create
            'click (lambda (e)
                     (this.trigger :edit-name)))
    render (lambda ()
             (this.$el.text (this.channel.name))))

(defview *Channel-view
    model 'channel
    events (create
            'mousedown (lambda (e)
                         ((@ e prevent-default)))
            'click (lambda (e)
                     ((@ e prevent-default))
                     (this.trigger :channel-select this)))

    init (lambda (model)
           (this.create 'title-view (new (*View *Channel-title-view this.channel)))
           (this.create 'name-view (new (*View *Channel-name-view this.channel)))
           (this.create 'controls-view (new (*View *Channel-controls-view this.channel)))
           (this.create 'monitor-view (new (*View *Channel-monitor-view)))
           (this.create 'selected f)
           (this.on :edit-name (lambda (e)
                                 ((@ this name-view)
                                  (new (*View *Channel-name-edit-view
                                              this.channel
                                              this.channel.name)))
                                 (this.render)
                                 ((@ (@ ((@ this name-view)) $el) focus))
                                 ((@ (@ ((@ this name-view)) $el) select))
                                 ))
           (this.on :end-edit-name (lambda (e)
                                     ((@ this name-view)
                                      (new (*View *Channel-name-view
                                                  this.channel)))
                                     (this.render)))
           (this.on "change:selected" (lambda (e)
                                        ((@ this $el toggle-class) "ChannelSelected"))))
    render (lambda ()
             (this.clear)
             (let* ((i 0)
                    (html (this.channel.map
                           (lambda (note)
                             (let ((view (new (*View *Note-view note))))
                               (when (= 0 (rem i 4))
                                 ((@ (@ view $el) attr) :class "NoteViewHighlight"))
                               (incf i)
                               (this.add view)
                               ((@  view render)))) this)))
               ((@ html unshift) ((@ ((@ this controls-view)) render)))
               ((@ html unshift) ((@ ((@ this monitor-view)) render)))
               ((@ html unshift) ((@ ((@ this name-view)) render)))
               ((@ html unshift) ((@ ((@ this title-view)) render)))
               (this.$el.html html))))
